<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>eTRU Metrics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: rgb(255, 255, 255);
      margin: 0;
      padding: 0;
      color: #2b2f32;
    }

    .header-banner {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      width: 100%;
      background-color: #f5f6f6;
      color: #2b2f32;
      padding: 10px 16px;
      border-bottom: 1.75px solid #dbe2ea;
    }

    .header-banner h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 300;
    }

    .dashboard-container {
      max-width: 1450px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .facilitySelectorCommonComponent {
      display: flex;
      align-items: center;
      margin: 2rem 0;
      gap: 1rem;
      font-size: 1.75rem;
      font-weight: 300;
    }

    .dashboard-section {
      margin: 3rem 0;
    }

    .section-header {
      font-size: 1.75rem;
      color: #2b2f32;
      margin: 0 0 1rem;
      font-weight: 300;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #dbe2ea;
    }

    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      margin: 1rem 0;
      justify-content: flex-start;
    }

    .metric-card {
      background: #ffffff;
      border-radius: 14px;
      border: 14px solid rgb(206, 206, 206);
      box-shadow: none;
      padding: 1.5rem 2rem;
      flex: 1 1 280px;
      min-width: 310px;
      text-align: left;
      margin: 0.1rem;
      transform: translateZ(0);
    }

    .metric-card h2 {
      font-size: 1.5rem;
      color: rgba(0, 0, 0, 0.6);
      margin: 0 0 0.5rem;
      font-weight: 400;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .metric-card .value {
      font-size: 3.25rem;
      font-weight: 700;
      color: #1e293b;
    }

    h2.section-title {
      text-align: left;
      font-size: 1.75rem;
      color: #2b2f32;
      margin: 3rem 0 1rem;
      font-weight: 300;
    }

    canvas {
      width: 100%;
      background: white;
      border-radius: 12px;
      padding: 1rem;
      border: 14px solid rgb(206, 206, 206);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    /* Add this to your existing <style> section */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-overlay.active {
  display: flex;
}

.loading-spinner {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #dbe2ea;
  border-top: 4px solid #2c7be5;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  font-size: 1.2rem;
  color: #2b2f32;
  font-weight: 300;
}
/* Add to your existing <style> section */
    .header-controls {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-left: auto;
}

.export-button {
  padding: 0.75rem 1.5rem;
  background-color: #2c7be5;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
  white-space: nowrap;
}

.export-button:hover {
  background-color: #1e5bb8;
}

.export-button:active {
  background-color: #164a94;
}

.export-button:disabled {
  background-color: #94a3b8;
  cursor: not-allowed;
}

#exportDropdownMenu button:hover {
  background-color: #f5f6f6;
}
  </style>
</head>
<body>
    <!-- ✅ Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">Loading metrics...</div>
      </div>
    </div>
  
    <div class="header-banner">
        <h1>Nsight Fleet Charge Dashboard</h1>
    </div>

    <div class="dashboard-container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; margin-top: 1rem;">
          <h1 style="margin: 0;">Lineage - Statesville eTRU Metrics</h1>
          <div style="position: relative;">
            <button id="exportDropdownButton" class="export-button" style="display: flex; align-items: center; gap: 0.5rem;">
              Export
              <span style="font-size: 0.8rem;">▼</span>
            </button>
            <div id="exportDropdownMenu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 0.25rem; background: white; border: 1px solid #dbe2ea; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); min-width: 250px; z-index: 1000;">
              <button id="exportKPIsButton" style="width: 100%; padding: 0.75rem 1rem; text-align: left; border: none; background: none; cursor: pointer; font-size: 1rem; border-bottom: 1px solid #dbe2ea; transition: background-color 0.2s;">
                Export Last 6 Months KPIs
              </button>
              <button id="exportSessionsButton" style="width: 100%; padding: 0.75rem 1rem; text-align: left; border: none; background: none; cursor: pointer; font-size: 1rem; transition: background-color 0.2s;">
                Export All Sessions for Selected Period
              </button>
            </div>
          </div>
        </div>

    <div class="facilitySelectorCommonComponent" style="margin-bottom: 1rem;">
      <label for="dateRange">Date Range:</label>
      <select id="dateRange" style="padding: 0.5rem; font-size: 1rem; border-radius: 6px; border: 1px solid #dbe2ea;">
        <option value="last-month">Last Month</option>
        <option value="this-month">This Month</option>
        <option value="last-7-days">Last 7 Days</option>
        <option value="last-30-days">Last 30 Days</option>
        <option value="last-90-days">Last 90 Days</option>
        <option value="ytd">Year to Date</option>
        <option value="custom">Custom Range</option>
      </select>
      
      <div id="customDateInputs" style="display: none; margin-left: 1rem;">
        <label for="customStart">From:</label>
        <input type="date" id="customStart" style="margin-left: 0.5rem; padding: 0.5rem;" />
        <label for="customEnd" style="margin-left: 1rem;">To:</label>
        <input type="date" id="customEnd" style="margin-left: 0.5rem; padding: 0.5rem;" />
      </div>
    </div>

    <!-- ✅ SECTION 1: eTRU Entry -->
    <div class="dashboard-section">
      <h2 class="section-header">eTRU Entry</h2>
      <div class="card-container">
        <div class="metric-card">
          <h2>eTRU Trailers</h2>
          <div class="value" id="count1">Loading...</div>
        </div>
        <div class="metric-card">
          <h2>eTRU-Enabled Trailer %</h2>
          <div class="value" id="percentEtruEnabled">Loading...</div>
        </div>
      </div>
    </div>

    <!-- ✅ SECTION 2: eTRU Assignment -->
    <div class="dashboard-section">
      <h2 class="section-header">eTRU Assignment</h2>
      <div class="card-container">
        <div class="metric-card">
          <h2>eTRU Missed Assignments</h2>
          <div class="value" id="count2">Loading...</div>
        </div>
        <div class="metric-card">
          <h2>eTRU Assignment Rate</h2>
          <div class="value" id="count3">Loading...</div>
        </div>
      </div>
    </div>

    <!-- ✅ SECTION 3: Charging Time -->
    <div class="dashboard-section">
      <h2 class="section-header">Charging Time</h2>
      <div class="card-container">
        <div class="metric-card">
          <h2>Assigned Charging Time</h2>
          <div class="value" id="assignedChargingTime">Loading...</div>
        </div>
        <div class="metric-card">
          <h2>Unassigned Charging Time</h2>
          <div class="value" id="unassignedChargingTime">Loading...</div>
        </div>
        <div class="metric-card">
          <h2>Total Charging Time</h2>
          <div class="value" id="totalChargingTime">Loading...</div>
        </div>
      </div>
    </div>

    <!-- ✅ SECTION 4: Consumption -->
    <div class="dashboard-section">
      <h2 class="section-header">Consumption</h2>
      <div class="card-container">
        <div class="metric-card">
          <h2>Total Assigned Usage</h2>
          <div class="value" id="totalAssignedUsage">Loading...</div>
        </div>
        <div class="metric-card">
          <h2>Total Unassigned Usage</h2>
          <div class="value" id="totalUnassignedUsage">Loading...</div>
        </div>
        <div class="metric-card">
          <h2>Total Usage</h2>
          <div class="value" id="totalUsage">Loading...</div>
        </div>
      </div>
    </div>

    <!-- ✅ Chart at the bottom -->
    <h2 class="section-title">eTRU Trailer Appointments Over Time</h2>
    <canvas id="lineChart" height="300"></canvas>

    <!-- ✅ Daily Consumption Bar Chart -->
    <h2 class="section-title">Daily Energy Consumption</h2>
    <canvas id="dailyConsumptionChart" height="300"></canvas>
  </div>

<script>
  const dateRangeSelect = document.getElementById('dateRange');
  const customDateInputs = document.getElementById('customDateInputs');
  const customStartInput = document.getElementById('customStart');
  const customEndInput = document.getElementById('customEnd');

  const now = new Date();
  const todayStr = now.toISOString().split('T')[0];

  // Set max dates for custom inputs
  customStartInput.max = todayStr;
  customEndInput.max = todayStr;

  let lineChart;
  let dailyConsumptionChart;

  // Dropdown menu functionality
  const exportDropdownButton = document.getElementById('exportDropdownButton');
  const exportDropdownMenu = document.getElementById('exportDropdownMenu');

  exportDropdownButton.addEventListener('click', (e) => {
    e.stopPropagation();
    exportDropdownMenu.style.display = exportDropdownMenu.style.display === 'none' ? 'block' : 'none';
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    exportDropdownMenu.style.display = 'none';
  });

  // Prevent dropdown from closing when clicking inside
  exportDropdownMenu.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Function to calculate date range based on selection
  function getDateRange(rangeType) {
    const now = new Date();
    let startDate, endDate;

    switch(rangeType) {
      case 'last-month':
        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), 0);
        break;
      
      case 'this-month':
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        break;
      
      case 'last-7-days':
        endDate = new Date(now);
        endDate.setDate(endDate.getDate() + 1)
        startDate = new Date(now);
        startDate.setDate(startDate.getDate() - 7);
        break;
      
      case 'last-30-days':
        endDate = new Date(now);
        endDate.setDate(endDate.getDate() + 1)
        startDate = new Date(now);
        startDate.setDate(startDate.getDate() - 30);
        break;
      
      case 'last-90-days':
        endDate = new Date(now);
        endDate.setDate(endDate.getDate() + 1)
        startDate = new Date(now);
        startDate.setDate(startDate.getDate() - 90);
        break;
      
      case 'ytd':
        startDate = new Date(now.getFullYear(), 0, 1);
        endDate = new Date(now);
        endDate.setDate(endDate.getDate() + 1)
        break;
      
      case 'custom':
        // Return null to indicate custom dates should be used
        return null;
      
      default:
        // Default to last month
        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), 0);
    }

    return {
      start: startDate.toISOString().split('T')[0],
      end: endDate.toISOString().split('T')[0]
    };
  }

  // Handle date range selection
  dateRangeSelect.addEventListener('change', () => {
    const selectedRange = dateRangeSelect.value;
    
    if (selectedRange === 'custom') {
      customDateInputs.style.display = 'inline-block';
      
      // Set default custom dates if not already set
      if (!customStartInput.value || !customEndInput.value) {
        const lastMonth = getDateRange('last-month');
        customStartInput.value = lastMonth.start;
        customEndInput.value = lastMonth.end;
      }
    } else {
      customDateInputs.style.display = 'none';
      updateFilters();
    }
  });

  // Handle custom date changes
  customStartInput.addEventListener('change', () => {
    customEndInput.min = customStartInput.value;
    if (customEndInput.value && customEndInput.value < customStartInput.value) {
      customEndInput.value = customStartInput.value;
    }
    updateFilters();
  });

  customEndInput.addEventListener('change', () => {
    updateFilters();
  });

  function updateFilters() {
    const selectedRange = dateRangeSelect.value;
    let startDateStr, endDateStr;

    if (selectedRange === 'custom') {
      const today = new Date().toISOString().split('T')[0];
      
      if (!customStartInput.value || !customEndInput.value) {
        alert("Please select both start and end dates.");
        return;
      }
      
      if (customEndInput.value > today) {
        alert("End date cannot be in the future.");
        customEndInput.value = today;
        return;
      }
      
      if (customStartInput.value > today) {
        alert("Start date cannot be in the future.");
        customStartInput.value = today;
        return;
      }
      
      if (customEndInput.value < customStartInput.value) {
        alert("End date cannot be before start date.");
        return;
      }
      
      startDateStr = customStartInput.value;
      endDateStr = customEndInput.value;
    } else {
      const dateRange = getDateRange(selectedRange);
      startDateStr = dateRange.start;
      endDateStr = dateRange.end;
    }

    fetchMetrics(startDateStr, endDateStr);
  }

  function fetchMetrics(startDateStr, endDateStr) {
  // ✅ Show loading overlay
  const loadingOverlay = document.getElementById('loadingOverlay');
  loadingOverlay.classList.add('active');

  const isoStart = startDateStr;
  const isoEnd = endDateStr;

  // Track completion of all async operations
  let completedRequests = 0;
  const totalRequests = 3; // Trailer, Facility Usage, Submeter (charts are separate)

  function checkAllComplete() {
    completedRequests++;
    if (completedRequests >= totalRequests) {
      // ✅ Hide loading overlay when all main requests are done
      setTimeout(() => {
        loadingOverlay.classList.remove('active');
      }, 300); // Small delay for smooth transition
    }
  }

  const trailerQuery = `
    query($filter: TrailerAppointmentFilter, $parkSessionFilter: ParkSessionFilter) {
      trailerAppointments(filter: $filter) {
        nodes {
          checkinTime
          trailer {
            carrierCode
            supportEtru
            parkSessions(filter: $parkSessionFilter) {
              nodes {
                startTime
                endTime
                space {
                  etruEnabled
                  spaceCategory {
                    name
                  }
                }
              }
            }
          }
        }
      }
    }
  `;

  // Trailer Metrics
  fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: trailerQuery,
      variables: {
        filter: {
          checkinTime: { greaterThan: isoStart, lessThanOrEqualTo: isoEnd }
        },
        parkSessionFilter: {
          startTime: { greaterThan: isoStart }
        }
      }
    })
  })
  .then(res => res.json())
  .then(data => {
    const trailers = data?.data?.trailerAppointments?.nodes || [];
    const supportEtruCount = trailers.filter(t => t.trailer?.supportEtru).length;
    document.getElementById('count1').textContent = supportEtruCount;

    const totalAppointments = trailers.length;
    const etruPercent = totalAppointments
      ? Math.round((supportEtruCount / totalAppointments) * 100)
      : 0;
    document.getElementById('percentEtruEnabled').textContent = `${etruPercent}%`;

    let yardSessionsWithoutEtru = 0;
    let totalYardSessions = 0;
    let etruYardSessions = 0;
    let totalEtruParkTimeMs = 0;

    trailers.forEach(t => {
      if (!t.trailer?.supportEtru) return;
      (t.trailer.parkSessions.nodes || []).forEach(s => {
        if (s.space?.spaceCategory?.name?.toLowerCase() === 'yard') {
          totalYardSessions++;
          if (s.space.etruEnabled) {
            etruYardSessions++;
            if (s.startTime && s.endTime) {
              totalEtruParkTimeMs += (new Date(s.endTime) - new Date(s.startTime));
            }
          } else {
            yardSessionsWithoutEtru++;
          }
        }
      });
    });

    document.getElementById('count2').textContent = yardSessionsWithoutEtru;
    const assignmentRate = totalYardSessions
      ? Math.round((etruYardSessions / totalYardSessions) * 100)
      : 0;
    document.getElementById('count3').textContent = `${assignmentRate}%`;

    const totalEtruParkTimeHours = Math.round(totalEtruParkTimeMs / (1000 * 60 * 60));
    document.getElementById('totalEtruParkTime').textContent = `${totalEtruParkTimeHours.toLocaleString()} hrs`;

    checkAllComplete(); // ✅ Mark as complete
  })
  .catch(err => {
    console.error('Trailer metric fetch error:', err);
    checkAllComplete(); // ✅ Mark as complete even on error
  });

  // Total Facility Usage Query
const facilityUsageQuery = `
  query($from: String!, $to: String!) {
    submeters {
      usage(from: $from, to: $to, aggregation: SUM) {
        aggregates {
          SUM
        }
      }
    }
  }
`;

// Fetch Total Usage and store the promise
const totalUsagePromise = fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy-submeter', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: facilityUsageQuery,
    variables: {
      from: isoStart.split('T')[0],
      to: isoEnd.split('T')[0]
    }
  })
})
.then(res => res.json())
.then(data => {
  if (data.errors) {
    console.error('Facility usage query errors:', data.errors);
    document.getElementById('totalUsage').textContent = 'Error';
    checkAllComplete();
    return 0;
  }

  const totalFacilityUsage = data?.data?.submeters?.usage?.aggregates?.SUM || 0;
  document.getElementById('totalUsage').textContent = `${Math.round(totalFacilityUsage).toLocaleString()} kWh`;
  checkAllComplete();
  return totalFacilityUsage;
})
.catch(err => {
  console.error('Facility usage fetch error:', err);
  document.getElementById('totalUsage').textContent = 'Error';
  checkAllComplete();
  return 0;
});

// Submeter Session Metrics (Charging Time)
const submeterQuery = `
  query($filter: SubmeterSessionFilter) {
    submeterSessions(filter: $filter) {
      nodes {
        id
        startTime
        endTime
        associatedCustomerId
        usage { aggregates { SUM } }
      }
    }
  }
`;

fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy-submeter', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: submeterQuery,
    variables: {
      filter: {
        startTime: { greaterThanOrEqualTo: isoStart, lessThanOrEqualTo: isoEnd }
      }
    }
  })
})
.then(res => res.json())
.then(async data => {
  const sessions = data?.data?.submeterSessions?.nodes || [];

  let assignedDurationMs = 0;
  let unassignedDurationMs = 0;
  let totalDurationMs = 0;
  
  sessions.forEach(s => {
    if (s.startTime && s.endTime) {
      const duration = new Date(s.endTime) - new Date(s.startTime);
      totalDurationMs += duration;
      
      // If associatedCustomerId is null, it's unassigned
      if (s.associatedCustomerId === null) {
        unassignedDurationMs += duration;
      } else {
        assignedDurationMs += duration;
      }
    }
  });
  
  const assignedHours = Math.round(assignedDurationMs / (1000 * 60 * 60));
  const unassignedHours = Math.round(unassignedDurationMs / (1000 * 60 * 60));
  const totalHours = Math.round(totalDurationMs / (1000 * 60 * 60));
  
  document.getElementById('assignedChargingTime').textContent = `${assignedHours.toLocaleString()} hrs`;
  document.getElementById('unassignedChargingTime').textContent = `${unassignedHours.toLocaleString()} hrs`;
  document.getElementById('totalChargingTime').textContent = `${totalHours.toLocaleString()} hrs`;

  let totalAssignedUsage = 0;
  sessions.forEach(s => {
    totalAssignedUsage += s.usage?.aggregates?.SUM || 0;
  });
  const roundedAssignedUsage = Math.round(totalAssignedUsage);
  document.getElementById('totalAssignedUsage').textContent = `${roundedAssignedUsage.toLocaleString()} kWh`;

  // ✅ FIXED: Wait for total usage and calculate with actual values
  const totalUsage = await totalUsagePromise;
  const unassignedUsage = Math.max(0, Math.round(totalUsage) - roundedAssignedUsage);
  document.getElementById('totalUnassignedUsage').textContent = `${unassignedUsage.toLocaleString()} kWh`;

  // Charging % of Parked Time
  fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: `
        query($filter: TrailerAppointmentFilter, $parkSessionFilter: ParkSessionFilter) {
          trailerAppointments(filter: $filter) {
            nodes {
              trailer {
                parkSessions(filter: $parkSessionFilter) {
                  nodes {
                    startTime
                    endTime
                    space { etruEnabled }
                  }
                }
              }
            }
          }
        }
      `,
      variables: {
        filter: {
          checkinTime: { greaterThan: isoStart, lessThanOrEqualTo: isoEnd }
        },
        parkSessionFilter: {
          startTime: { greaterThan: isoStart }
        }
      }
    })
  })
  .then(res => res.json())
  .then(data => {
    let totalParkMs = 0;
    (data.data.trailerAppointments.nodes || []).forEach(t => {
      (t.trailer.parkSessions.nodes || []).forEach(s => {
        if (s.space?.etruEnabled && s.startTime && s.endTime) {
          totalParkMs += (new Date(s.endTime) - new Date(s.startTime));
        }
      });
    });
    const chargePct = totalParkMs
      ? Math.round((totalDurationMs / totalParkMs) * 100)
      : 0;
    document.getElementById('chargingPercent').textContent = `${chargePct}%`;
  })
  .catch(err => {
    console.error('Charging % calc error:', err);
    document.getElementById('chargingPercent').textContent = 'Error';
  });

  checkAllComplete();
})
.catch(err => {
  console.error('Submeter fetch error:', err);
  checkAllComplete();
});

  // Chart: Last 180 Days (separate from main loading)
  const chartStart = new Date(endDateStr);
  chartStart.setDate(chartStart.getDate() - 180);

  fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: trailerQuery,
      variables: {
        filter: { 
          checkinTime: { greaterThan: chartStart.toISOString() } 
        },
        parkSessionFilter: {
          startTime: { greaterThan: chartStart.toISOString() }
        }
      }
    })
  })
  .then(res => res.json())
  .then(chartData => {
    const chartTrailers = chartData?.data?.trailerAppointments?.nodes || [];
    const bucketLabels = [];
    const bucketCounts = {};
    const bucketRanges = [];
    let current = new Date(chartStart.getFullYear(), chartStart.getMonth(), 1);

    for (let i = 0; i < 6; i++) {
      const start = new Date(current.getFullYear(), current.getMonth(), 1);
      const end   = new Date(current.getFullYear(), current.getMonth() + 1, 1);
      const label = start.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      bucketLabels.push(label);
      bucketCounts[label] = 0;
      bucketRanges.push({ start, end, label });
      current.setMonth(current.getMonth() + 1);
    }

    chartTrailers.forEach(t => {
      if (!t.trailer?.supportEtru || !t.checkinTime) return;
      const checkinDate = new Date(t.checkinTime);
      bucketRanges.forEach(({ start, end, label }) => {
        if (checkinDate >= start && checkinDate < end) {
          bucketCounts[label]++;
        }
      });
    });

    const ctx = document.getElementById('lineChart').getContext('2d');
    if (lineChart) lineChart.destroy();
    lineChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: bucketLabels,
        datasets: [{
          label: 'eTRU Appointments',
          data: bucketLabels.map(l => bucketCounts[l]),
          borderColor: '#2c7be5',
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          pointBackgroundColor: '#2c7be5'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: items => {
                const { dataIndex } = items[0];
                const { start, end } = bucketRanges[dataIndex];
                return `${start.toLocaleDateString()} – ${end.toLocaleDateString()}`;
              },
              label: ctx => `${ctx.parsed.y} appointments`
            }
          }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  })
  .catch(err => console.error('Chart data fetch error:', err));

  // ✅ NEW: Fetch Daily Consumption Data for Bar Chart
  fetchDailyConsumption(isoStart, isoEnd);
}

// ✅ NEW: Function to fetch and display daily consumption
function fetchDailyConsumption(startDateStr, endDateStr) {
  const dailyConsumptionQuery = `
    query($from: String!, $to: String!) {
      submeters {
        usage(
          from: $from
          to: $to
          aggregation: SUM
          window: "1 day"
          samplingWindow: "1 day"
        ) {
          nodes {
            time
            data
          }
        }
      }
    }
  `;

  fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy-submeter', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: dailyConsumptionQuery,
      variables: {
        from: startDateStr.split('T')[0],
        to: endDateStr.split('T')[0]
      }
    })
  })
  .then(res => res.json())
  .then(data => {
    const nodes = data?.data?.submeters?.usage?.nodes || [];
    
    // Prepare data for chart
    const labels = [];
    const consumptionData = [];

    nodes.forEach(node => {
      const date = new Date(node.time);
      const dateLabel = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      labels.push(dateLabel);
      consumptionData.push(Math.round(node.data));
    });

    // Create or update the bar chart
    const ctx = document.getElementById('dailyConsumptionChart').getContext('2d');
    if (dailyConsumptionChart) {
      dailyConsumptionChart.destroy();
    }
    
    dailyConsumptionChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Daily Consumption (kWh)',
          data: consumptionData,
          backgroundColor: '#2c7be5',
          borderColor: '#1e5bb8',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { 
            display: true,
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.parsed.y.toLocaleString()} kWh`;
              }
            }
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' kWh';
              }
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          }
        }
      }
    });
  })
  .catch(err => {
    console.error('Daily consumption fetch error:', err);
  });
}

// Export Last 6 Months KPIs functionality
document.getElementById('exportKPIsButton').addEventListener('click', async () => {
  // Close dropdown
  exportDropdownMenu.style.display = 'none';
  
  const exportButton = document.getElementById('exportDropdownButton');
  const loadingOverlay = document.getElementById('loadingOverlay');
  
  // Disable button and show loading
  exportButton.disabled = true;
  exportButton.textContent = 'Exporting...';
  loadingOverlay.classList.add('active');

  try {
    const now = new Date();
    const monthsData = [];

    // Generate data for last 6 months
    for (let i = 5; i >= 0; i--) {
      const monthStart = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthEnd = new Date(now.getFullYear(), now.getMonth() - i + 1, 0);
      
      const startStr = monthStart.toISOString().split('T')[0];
      const endStr = monthEnd.toISOString().split('T')[0];
      const monthLabel = monthStart.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

      const monthMetrics = await fetchMetricsForExport(startStr, endStr);
      monthsData.push({
        month: monthLabel,
        ...monthMetrics
      });
    }

    // Generate CSV
    const csv = generateCSV(monthsData);
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `etru-kpis-last-6-months-${now.toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

  } catch (error) {
    console.error('Export error:', error);
    alert('Failed to export data. Please try again.');
  } finally {
    // Re-enable button and hide loading
    exportButton.disabled = false;
    exportButton.innerHTML = 'Export <span style="font-size: 0.8rem;">▼</span>';
    loadingOverlay.classList.remove('active');
  }
});

// Export All Metering Sessions functionality
document.getElementById('exportSessionsButton').addEventListener('click', async () => {
  // Close dropdown
  exportDropdownMenu.style.display = 'none';
  
  const exportButton = document.getElementById('exportDropdownButton');
  const loadingOverlay = document.getElementById('loadingOverlay');
  
  // Disable button and show loading
  exportButton.disabled = true;
  exportButton.textContent = 'Exporting...';
  loadingOverlay.classList.add('active');

  try {
    const selectedRange = dateRangeSelect.value;
    let startDateStr, endDateStr;

    if (selectedRange === 'custom') {
      if (!customStartInput.value || !customEndInput.value) {
        alert("Please select both start and end dates.");
        return;
      }
      startDateStr = customStartInput.value;
      endDateStr = customEndInput.value;
    } else {
      const dateRange = getDateRange(selectedRange);
      startDateStr = dateRange.start;
      endDateStr = dateRange.end;
    }

    // Fetch all metering sessions
    const sessionsQuery = `
      query($filter: SubmeterSessionFilter) {
        submeterSessions(filter: $filter) {
          nodes {
            associatedCustomer {
              name
            }
            submeter {
              facility {
                name
              }
              label
            }
            startTime
            endTime
            usage {
              aggregates {
                SUM
              }
            }
          }
        }
      }
    `;

    const response = await fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy-submeter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: sessionsQuery,
        variables: {
          filter: {
            startTime: { greaterThanOrEqualTo: startDateStr, lessThanOrEqualTo: endDateStr }
          }
        }
      })
    });

    const data = await response.json();
    const sessions = data?.data?.submeterSessions?.nodes || [];

    // Filter out sessions with 0 kWh usage
    const filteredSessions = sessions.filter(session => {
      const usage = session.usage?.aggregates?.SUM || 0;
      return usage > 0;
    });

    if (filteredSessions.length === 0) {
      alert('No metering sessions with usage found for the selected date range.');
      return;
    }

    // Generate CSV for sessions
    const csv = generateSessionsCSV(filteredSessions);
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `metering-sessions-${startDateStr}-to-${endDateStr}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

  } catch (error) {
    console.error('Export sessions error:', error);
    alert('Failed to export sessions. Please try again.');
  } finally {
    // Re-enable button and hide loading
    exportButton.disabled = false;
    exportButton.innerHTML = 'Export <span style="font-size: 0.8rem;">▼</span>';
    loadingOverlay.classList.remove('active');
  }
});

// Fetch metrics for a specific month (for export)
async function fetchMetricsForExport(startDateStr, endDateStr) {
  const isoStart = startDateStr;
  const isoEnd = endDateStr;

  const trailerQuery = `
    query($filter: TrailerAppointmentFilter, $parkSessionFilter: ParkSessionFilter) {
      trailerAppointments(filter: $filter) {
        nodes {
          checkinTime
          trailer {
            carrierCode
            supportEtru
            parkSessions(filter: $parkSessionFilter) {
              nodes {
                startTime
                endTime
                space {
                  etruEnabled
                  spaceCategory {
                    name
                  }
                }
              }
            }
          }
        }
      }
    }
  `;

  const metrics = {
    etruTrailers: 0,
    etruEnabledPercent: 0,
    missedAssignments: 0,
    assignmentRate: 0,
    totalEtruParkTime: 0,
    totalChargingTime: 0,
    chargingPercent: 0,
    totalUsage: 0,
    totalAssignedUsage: 0,
    totalUnassignedUsage: 0
  };

  try {
    // Fetch trailer data
    const trailerResponse = await fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: trailerQuery,
        variables: {
          filter: {
            checkinTime: { greaterThan: isoStart, lessThanOrEqualTo: isoEnd }
          },
          parkSessionFilter: {
            startTime: { greaterThan: isoStart }
          }
        }
      })
    });

    const trailerData = await trailerResponse.json();
    const trailers = trailerData?.data?.trailerAppointments?.nodes || [];
    
    metrics.etruTrailers = trailers.filter(t => t.trailer?.supportEtru).length;
    const totalAppointments = trailers.length;
    metrics.etruEnabledPercent = totalAppointments
      ? Math.round((metrics.etruTrailers / totalAppointments) * 100)
      : 0;

    let yardSessionsWithoutEtru = 0;
    let totalYardSessions = 0;
    let etruYardSessions = 0;
    let totalEtruParkTimeMs = 0;
    let totalParkMs = 0;

    trailers.forEach(t => {
      if (!t.trailer?.supportEtru) return;
      (t.trailer.parkSessions.nodes || []).forEach(s => {
        if (s.space?.spaceCategory?.name?.toLowerCase() === 'yard') {
          totalYardSessions++;
          if (s.space.etruEnabled) {
            etruYardSessions++;
            if (s.startTime && s.endTime) {
              const duration = new Date(s.endTime) - new Date(s.startTime);
              totalEtruParkTimeMs += duration;
              totalParkMs += duration;
            }
          } else {
            yardSessionsWithoutEtru++;
          }
        }
      });
    });

    metrics.missedAssignments = yardSessionsWithoutEtru;
    metrics.assignmentRate = totalYardSessions
      ? Math.round((etruYardSessions / totalYardSessions) * 100)
      : 0;
    metrics.totalEtruParkTime = Math.round(totalEtruParkTimeMs / (1000 * 60 * 60));

    // Fetch facility usage
    const facilityUsageQuery = `
      query($from: String!, $to: String!) {
        submeters {
          usage(from: $from, to: $to, aggregation: SUM) {
            aggregates {
              SUM
            }
          }
        }
      }
    `;

    const facilityResponse = await fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy-submeter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: facilityUsageQuery,
        variables: {
          from: isoStart.split('T')[0],
          to: isoEnd.split('T')[0]
        }
      })
    });

    const facilityData = await facilityResponse.json();
    metrics.totalUsage = Math.round(facilityData?.data?.submeters?.usage?.aggregates?.SUM || 0);

    // Fetch submeter sessions
    const submeterQuery = `
      query($filter: SubmeterSessionFilter) {
        submeterSessions(filter: $filter) {
          nodes {
            id
            startTime
            endTime
            usage { aggregates { SUM } }
          }
        }
      }
    `;

    const submeterResponse = await fetch('https://lin-statesville-etru-dash-proxy.onrender.com/proxy-submeter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: submeterQuery,
        variables: {
          filter: {
            startTime: { greaterThanOrEqualTo: isoStart, lessThanOrEqualTo: isoEnd }
          }
        }
      })
    });

    const submeterData = await submeterResponse.json();
    const sessions = submeterData?.data?.submeterSessions?.nodes || [];

    let totalDurationMs = 0;
    let totalAssignedUsage = 0;

    sessions.forEach(s => {
      if (s.startTime && s.endTime) {
        totalDurationMs += (new Date(s.endTime) - new Date(s.startTime));
      }
      totalAssignedUsage += s.usage?.aggregates?.SUM || 0;
    });

    metrics.totalChargingTime = Math.round(totalDurationMs / (1000 * 60 * 60));
    metrics.totalAssignedUsage = Math.round(totalAssignedUsage);
    metrics.totalUnassignedUsage = Math.max(0, metrics.totalUsage - metrics.totalAssignedUsage);
    metrics.chargingPercent = totalParkMs
      ? Math.round((totalDurationMs / totalParkMs) * 100)
      : 0;

  } catch (error) {
    console.error('Error fetching metrics for export:', error);
  }

  return metrics;
}

// Generate CSV from metrics data
function generateCSV(data) {
  const headers = [
    'Month',
    'eTRU Trailers',
    'eTRU-Enabled Trailer %',
    'eTRU Missed Assignments',
    'eTRU Assignment Rate %',
    'Total Time in eTRU Spaces (hrs)',
    'Total Charging Time (hrs)',
    'Charging Time % of Parked Time',
    'Total Assigned Usage (kWh)',
    'Total Unassigned Usage (kWh)',
    'Total Usage (kWh)'
  ];

  const rows = data.map(d => [
    d.month,
    d.etruTrailers,
    d.etruEnabledPercent,
    d.missedAssignments,
    d.assignmentRate,
    d.totalEtruParkTime,
    d.totalChargingTime,
    d.chargingPercent,
    d.totalAssignedUsage,
    d.totalUnassignedUsage,
    d.totalUsage
  ]);

  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.join(','))
  ].join('\n');

  return csvContent;
}

// Generate CSV from metering sessions data
function generateSessionsCSV(sessions) {
  const headers = [
    'Date',
    'Facility',
    'eTRU Station',
    'Customer',
    'Session Start',
    'Session End',
    'Duration (minutes)',
    'Total kWh'
  ];

  const rows = sessions.map(session => {
    const startTime = new Date(session.startTime);
    const endTime = new Date(session.endTime);
    const durationMinutes = Math.round((endTime - startTime) / (1000 * 60));
    
    const date = startTime.toLocaleDateString('en-US');
    const facility = session.submeter?.facility?.name || '';
    const station = session.submeter?.label || '';
    const customer = session.associatedCustomer?.name || 'Unassigned';
    const sessionStart = startTime.toLocaleString('en-US');
    const sessionEnd = endTime.toLocaleString('en-US');
    const kwh = (session.usage?.aggregates?.SUM || 0).toFixed(2);

    return [
      date,
      facility,
      station,
      customer,
      sessionStart,
      sessionEnd,
      durationMinutes,
      kwh
    ];
  });

  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => {
      // Escape cells that contain commas
      if (typeof cell === 'string' && cell.includes(',')) {
        return `"${cell}"`;
      }
      return cell;
    }).join(','))
  ].join('\n');

  return csvContent;
}

// Initial load with "Last Month" as default
updateFilters();
</script>
</body>
</html>
